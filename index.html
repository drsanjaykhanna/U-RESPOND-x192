<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U-RESPOND Participant Questionnaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for form elements */
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            transition: 0.2s all linear;
            margin-right: 0.5rem;
            position: relative;
            top: 0.2rem;
        }
        .form-radio:checked {
            border: 6px solid #2563eb;
        }
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            transition: 0.2s all linear;
            margin-right: 0.5rem;
            position: relative;
            top: 0.2rem;
        }
        .form-checkbox:checked {
            background-color: #2563eb;
            border-color: #2563eb;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        .scale-radio:checked {
            border-color: #2563eb;
            background-color: #2563eb;
        }
        .progress-bar-fill {
            transition: width 0.3s ease-in-out;
        }
        /* Slider custom styles */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #d1d5db;
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -8px;
        }
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #d1d5db;
            border-radius: 5px;
        }
        input[type=range]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
        }
        .dce-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .dce-table th, .dce-table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: center;
        }
        .dce-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .dce-table td.feature-label {
            text-align: left;
            font-weight: 500;
            background-color: #f9fafb;
        }
        .dce-choice-label {
            display: block;
            margin-top: 1rem;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dce-choice-label:hover {
            background-color: #f9fafb;
        }
        input[type="radio"]:checked + .dce-choice-label {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto max-w-3xl p-4 sm:p-8">
        <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-lg">
            
            <div class="flex justify-center items-center py-4 border-b mb-6">
                <svg class="h-16 sm:h-20" viewBox="0 0 250 60" xmlns="http://www.w3.org/2000/svg">
                    <style>
                      .title { font-family: 'Inter', sans-serif; font-size: 26px; font-weight: 800; fill: #1e3a8a; }
                      .subtitle { font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 500; fill: #3b82f6; letter-spacing: 0.1em; }
                    </style>
                    <g>
                      <circle cx="30" cy="30" r="20" stroke="#3b82f6" stroke-width="4" fill="none"/>
                      <circle cx="30" cy="30" r="12" stroke="#3b82f6" stroke-width="4" fill="none"/>
                      <circle cx="30" cy="30" r="4" fill="#3b82f6"/>
                      <text x="70" y="30" class="title">U-RESPOND</text>
                      <text x="70" y="48" class="subtitle">STUDY</text>
                    </g>
                </svg>
            </div>

            <div class="text-center pb-4 mb-6">
                <p class="text-xl text-gray-800 font-bold">Participant Questionnaire</p>
            </div>

            <div id="progress-container" class="mb-8">
                <div class="flex justify-between mb-1">
                    <span id="progress-text" class="text-base font-medium text-blue-700"></span>
                    <span id="progress-percentage" class="text-sm font-medium text-blue-700"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
                </div>
            </div>

            <div id="questionnaire-container">
                <!-- Questions will be dynamically inserted here -->
            </div>

            <div id="navigation-container" class="mt-8 flex justify-between items-center">
                <button id="back-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out">Back</button>
                <button id="next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out">Next</button>
                <button id="submit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out hidden">Submit</button>
            </div>
            
            <div id="message-box" class="hidden mt-6 p-4 rounded-lg">
                <p id="message-text"></p>
            </div>

        </div>
        <footer class="text-center mt-6 text-sm text-gray-500">
            <p>Your responses are confidential and will be used for research purposes only.</p>
            <p>A study by The Royal Marsden NHS Foundation Trust & The Institute of Cancer Research</p>
        </footer>

        <footer class="w-full max-w-3xl mt-8 text-center mx-auto">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <p class="text-sm font-semibold text-gray-600 mb-4">In collaboration with:</p>
                <div class="flex flex-col items-center space-y-6">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/National_Health_Service_%28England%29_logo.svg/1280px-National_Health_Service_%28England%29_logo.svg.png" alt="NHS Logo" class="h-10 object-contain">
                    <img src="https://patientinfolibrary.royalmarsden.nhs.uk/themes/custom/rmt/logo.svg" alt="Royal Marsden Logo" class="h-12 object-contain">
                     <img src="https://www.southampton.ac.uk/img/ctu/SCTU%20logos/SCTU%20Logo%20(mediabin%20resized).jpg?csf=1&web=1&e=wbeGJs" alt="Southampton Clinical Trials Unit Logo" class="h-16 object-contain">
                </div>
            </div>
        </footer>
        </div>

    <script>
        // --- QUESTIONNAIRE DATA ---
        const questionnaireData = [
            {
                domain: "Welcome & Consent",
                questions: [
                    {
                        id: "welcome",
                        text: "Welcome to the U-RESPOND study questionnaire. Thank you for taking the time to contribute to this important research. This questionnaire will take approximately 20 minutes to complete.",
                        type: "info"
                    },
                    {
                        id: "participant_id",
                        text: "Please enter your Unique Participant ID Number",
                        type: "text",
                        placeholder: "e.g., URS-12345"
                    },
                    {
                        id: "consent_confirm",
                        text: "I confirm that I have read the participant information sheet and I voluntarily consent to participate in this study. I understand my data will be kept confidential and used for research purposes only.",
                        type: "checkbox"
                    }
                ]
            },
            {
                domain: "About You",
                questions: [
                    {
                        id: "demographics_explainer",
                        text: "These questions help us understand if we are hearing from a diverse range of people from all backgrounds. Your answers are kept completely confidential.",
                        type: "info"
                    },
                    { id: "age", text: "What is your age?", type: "number", placeholder: "e.g., 65" },
                    { id: "sex", text: "What is your sex assigned at birth?", type: "categorical", options: ["Male", "Female"] },
                    { id: "ethnic_group", text: "What is your ethnic group?", type: "categorical", options: ["White", "Mixed/Multiple ethnic groups", "Asian/Asian British", "Black/African/Caribbean/Black British", "Other ethnic group", "Prefer not to say"] },
                    { id: "ethnic_group_other", text: "Please specify your ethnic group", type: "text", placeholder: "Please specify", condition: { id: "ethnic_group", value: "Other ethnic group" }, optional: true },
                    { id: "education_level", text: "What is the highest level of education you have completed?", type: "categorical", options: ["No formal qualifications", "GCSEs/O-Levels or equivalent", "A-Levels or equivalent", "Undergraduate degree", "Postgraduate degree", "Prefer not to say"] },
                    { id: "employment_status", text: "Which of the following best describes your current employment status?", type: "categorical", options: ["Employed", "Self-employed", "Unemployed", "Retired", "Student", "Other"] },
                    { id: "employment_details", text: "Please tell us more about your employment (select all that apply):", type: "multi_checkbox", options: ["I work full-time", "I work part-time", "I have more than one job", "I am on a zero-hours contract"], condition: { id: "employment_status", value: "Employed" }, optional: true },
                    { id: "postcode", text: "What is the first part of your postcode?", type: "text", placeholder: "e.g., SW3" },
                    { id: "primary_language", text: "What is your primary language spoken at home?", type: "text", placeholder: "e.g., English" },
                    { id: "general_health", text: "How would you describe your general health?", type: "scale", options: ["Very good", "Good", "Fair", "Poor", "Very poor"] },
                ]
            },
            {
                domain: "Your Health Background",
                questions: [
                    // --- Smoking History ---
                    { id: "smoked_ever", text: "Have you ever smoked tobacco?", type: "Y/N" },
                    { id: "smoke_currently", text: "Do you currently smoke cigarettes/tobacco?", type: "Y/N", condition: { id: "smoked_ever", value: "Yes" } },
                    
                    // Questions for FORMER smokers
                    { id: "years_smoked_ex", text: "How many years did you smoke for?", type: "number", placeholder: "e.g., 20", condition: { logic: 'AND', rules: [{id: 'smoked_ever', value: 'Yes'}, {id: 'smoke_currently', value: 'No'}] } },
                    { id: "cigs_per_day_ex", text: "On average, how many cigarettes did you smoke per day (how much tobacco did you use)?", type: "text", placeholder: "e.g., 15 cigarettes", condition: { logic: 'AND', rules: [{id: 'smoked_ever', value: 'Yes'}, {id: 'smoke_currently', value: 'No'}] } },
                    { id: "years_quit", text: "How many years has it been since you last smoked regularly?", type: "number", placeholder: "e.g., 10", condition: { logic: 'AND', rules: [{id: 'smoked_ever', value: 'Yes'}, {id: 'smoke_currently', value: 'No'}] } },

                    // Questions for CURRENT smokers
                    { id: "years_smoked_current", text: "How many years have you smoked for?", type: "number", placeholder: "e.g., 30", condition: { logic: 'AND', rules: [{id: 'smoked_ever', value: 'Yes'}, {id: 'smoke_currently', value: 'Yes'}] } },
                    { id: "cigs_per_day_current", text: "On average, how many cigarettes/tobacco do you smoke per day?", type: "text", placeholder: "e.g., 20 cigarettes", condition: { logic: 'AND', rules: [{id: 'smoked_ever', value: 'Yes'}, {id: 'smoke_currently', value: 'Yes'}] } },

                    // --- Screening & Cancer History ---
                    { id: "other_screening", text: "Have you ever participated in cancer screening before (e.g. breast, colon cancer and/or cervical)?", type: "Y/N" },
                    { id: "lung_invite", text: "Have you ever received an invitation for an NHS Lung Health Check?", type: "Y/N/Unsure" },
                    { id: "lung_attended_completed", text: "Did you attend and complete the screening?", type: "Y/N", condition: { id: "lung_invite", value: "Yes" } },
                    { id: "lung_check_date", text: "Approximately when did you have the lung health check?", type: "text", placeholder: "e.g., 2023, or last year", condition: { id: "lung_attended_completed", value: "Yes" } },
                    
                    { id: "diagnosed_lc", text: "Have you ever been diagnosed with lung cancer?", type: "Y/N" },
                    { id: "diagnosed_lc_year", text: "Approximately which year were you diagnosed?", type: "text", placeholder: "e.g., 2022", condition: { id: "diagnosed_lc", value: "Yes" } },

                    { id: "family_diagnosed_lc", text: "Has a close family member (e.g. parent or sibling) ever been diagnosed with lung cancer?", type: "Y/N" },
                    { id: "family_diagnosed_lc_year", text: "Approximately which year were they diagnosed?", type: "text", placeholder: "e.g., 2020", condition: { id: "family_diagnosed_lc", value: "Yes" } },
                    
                    { id: "investigations_negative", text: "Have you had any investigations (e.g., scans, tests) for suspected lung cancer that turned out to be negative or non-cancerous?", type: "Y/N" },
                    { id: "investigations_negative_date", text: "Approximately when did this happen?", type: "text", placeholder: "e.g., last year", condition: { id: "investigations_negative", value: "Yes" } },
                ]
            },
            {
                domain: "What You Know About Lung Screening",
                questions: [
                    { id: "awareness_lcs", text: "How would you describe your awareness of national lung cancer screening?", type: "scale", options: ["Not at all aware", "Slightly aware", "Moderately aware", "Very aware", "Extremely aware"] },
                    { id: "lcs_sources", text: "From what sources have you heard about lung cancer screening? (Select all that apply)", type: "multi_checkbox", options: ["GP or nurse", "NHS letter or leaflet", "TV or radio", "Newspaper or magazine", "Online (e.g., websites, social media)", "Family or friends", "Other"], optional: true },
                    { id: "lcs_purpose", text: "What do you think is the main purpose of a lung health check?", type: "categorical", options: ["To find lung cancer early", "To prevent lung cancer", "To check for other lung problems", "I'm not sure"] },
                    { id: "lcs_scantype", text: "What type of scan is typically used for lung cancer screening?", type: "categorical", options: ["A CT scan", "An X-ray", "An MRI scan", "A blood test", "I'm not sure"] },
                    { id: "lcs_importance", text: "How important do you think screening for lung cancer is?", type: "slider", min: 0, max: 100, minLabel: "Not important at all", maxLabel: "Extremely important" },
                    { id: "knowledge_statement_1", text: "Lung cancer screening helps detect cancer early when it's easier to treat.", type: "T/F/DK" },
                    { id: "knowledge_statement_2", text: "Lung cancer screening reduces the risk of dying from lung cancer.", type: "T/F/DK" },
                    { id: "knowledge_statement_3", text: "Lung cancer screening is only recommended for people who currently smoke.", type: "T/F/DK" },
                    { id: "knowledge_statement_4", text: "Lung cancer screening always finds cancer if it's present.", type: "T/F/DK" },
                    { id: "knowledge_statement_5", text: "Lung cancer screening often results in further, more invasive tests.", type: "T/F/DK" }
                ]
            },
            {
                domain: "Possible Upsides of Screening",
                questions: [
                    {
                        id: "benefit_for_whom",
                        text: "In your opinion, what kind of person would benefit most from having a lung health check?",
                        type: "textarea",
                        placeholder: "e.g., people with a long smoking history, people with worries..."
                    },
                    { id: "benefit_main", text: "What is the main benefit of this test?", type: "textarea", placeholder: "Type your answer here..." },
                    { id: "motivation_intro", text: "For the following statements, please rate how much you agree or disagree.", type: "info" },
                    { id: "motivation_detect_early", text: "Knowing that lung cancer screening can detect cancer at an early, more treatable stage is a major motivation for me.", type: "agreement_scale" },
                    { id: "motivation_increase_survival", text: "I would participate in screening to increase my chances of surviving lung cancer if I were to get it.", type: "agreement_scale" },
                    { id: "motivation_peace_of_mind", text: "Lung cancer screening offers me a sense of peace of mind about my health.", type: "agreement_scale" },
                    { id: "motivation_responsibility", text: "I believe that people at risk for lung cancer have a responsibility to get screened.", type: "agreement_scale" },
                    { id: "motivation_doctor_rec", text: "My doctor's strong recommendation would be a primary reason for me to get screened.", type: "agreement_scale" },
                    { id: "motivation_family_worry", text: "I would participate in screening to reduce my family's worry about my health.", type: "agreement_scale" },
                    { id: "motivation_ranking", text: "Which of the following is the MOST important reason for you to consider screening?", type: "categorical", options: ["Detecting cancer early", "Increasing my chances of survival", "Giving me peace of mind", "It is my responsibility", "My doctor's recommendation", "Reducing my family's worry"] }
                ]
            },
            {
                domain: "Your Views on Lung Screening",
                questions: [
                    { id: "perceived_risk_population", text: "Out of 100 people, how many do you think will develop lung cancer in their lifetime?", type: "slider", min: 0, max: 100, minLabel: "0", maxLabel: "100" },
                    { id: "perceived_risk_personal", text: "What is your personal chance of developing lung cancer in your lifetime?", type: "slider", min: 0, max: 100, minLabel: "No chance", maxLabel: "Certain" },
                    { id: "seriousness_diagnosis", text: "How serious do you believe a diagnosis of lung cancer is?", type: "scale", options: ["Not at all serious", "Slightly serious", "Moderately serious", "Very serious", "Extremely serious"] },
                    { id: "barrier_main_reason", text: "What is the main reason to not have a lung cancer screen?", type: "textarea", placeholder: "Type your answer here..." },
                    { id: "barrier_intro", text: "To what extent would the following make you less likely to have a lung cancer screen:", type: "info" },
                    { id: "concern_radiation", text: "I am worried about the radiation exposure from a CT scan", type: "agreement_scale" },
                    { id: "concern_false_positive", text: "I would be anxious about receiving a 'false alarm' (a result that suggests a problem when there isn't one).", type: "agreement_scale" },
                    { id: "concern_finding_cancer", text: "The thought of finding out I have cancer makes me anxious", type: "agreement_scale" },
                    { id: "concern_inconvenience", text: "The screening process seems inconvenient (e.g., travel, time off work)", type: "agreement_scale" },
                    { id: "concern_stigma", text: "I feel there is a stigma associated with smoking that makes me reluctant to engage with screening", type: "agreement_scale" },
                    { id: "concern_follow_up", text: "I am worried about follow-up procedures if something suspicious is found", type: "agreement_scale" },
                    { id: "concern_no_difference", text: "I don't believe screening would make a difference for me personally", type: "agreement_scale" },
                    { id: "concern_uncomfortable", text: "I would feel uncomfortable undergoing a lung cancer screening scan", type: "agreement_scale" },
                    { id: "concern_lack_of_info", text: "Lack of information about lung cancer screening is a barrier for me", type: "agreement_scale" },
                    { id: "barrier_ranking", text: "Which of the following is the BIGGEST concern or reason that would make you less likely to have a lung cancer screen?", type: "categorical", options: ["Worry about radiation from the CT scan", "Anxiety about a false positive result", "Anxiety about finding out I have cancer", "Inconvenience (travel, time off work)", "Stigma associated with smoking", "Worry about follow-up procedures", "Belief that screening won't make a difference", "Discomfort with the scan itself", "Lack of information"] },
                    { id: "psych_hopeful", text: "How hopeful would you feel about the potential benefits?", type: "scale", options: ["Not at all hopeful", "Slightly hopeful", "Moderately hopeful", "Very hopeful", "Extremely hopeful"] },
                    { id: "psych_guilt", text: "How much guilt, if any, do you feel about your smoking history in relation to lung cancer?", type: "scale", options: ["No guilt at all", "A little guilt", "A moderate amount of guilt", "A lot of guilt", "A great deal of guilt"], condition: { id: "smoked_ever", value: "Yes" } },
                    { id: "psych_feelings", text: "When I think about getting lung cancer screening, I feel... (select all that apply)", type: "multi_checkbox", options: ["Anxious", "Hopeful", "Relieved", "Nervous", "Indifferent", "Empowered"], optional: true },
                    { id: "psych_personal_risk", text: "I feel that my personal risk of developing lung cancer is high.", type: "agreement_scale" },
                    { id: "psych_consequences", text: "The consequences of lung cancer (e.g., treatment, side effects) are very severe.", type: "agreement_scale" },
                    { id: "psych_confident_attend", text: "I feel confident that I can organise and attend lung cancer screening appointments.", type: "agreement_scale" },
                    { id: "psych_social_norm", text: "Most people important to me (e.g., family, close friends) would want me to get lung cancer screening.", type: "agreement_scale" },
                    { id: "psych_useful", text: "I believe participating in lung cancer screening would be useful for me.", type: "agreement_scale" },
                    { id: "psych_pleasant", text: "I believe participating in lung cancer screening would be a pleasant experience.", type: "agreement_scale" },
                    { id: "psych_control", text: "I have complete control over whether I participate in lung cancer screening.", type: "agreement_scale" },
                    { id: "psych_fate", text: "My health is mostly determined by fate or luck, not by my own actions.", type: "agreement_scale" },
                    { id: "psych_good_at_planning", text: "I am generally good at planning and remembering my medical appointments.", type: "agreement_scale" },
                    { id: "psych_judged", text: "I would feel judged by others if I attended lung cancer screening, due to my smoking history.", type: "agreement_scale" },
                    { id: "psych_blame", text: "Society tends to blame people who get lung cancer.", type: "agreement_scale" }
                ]
            },
            {
                domain: "Different Types of Screening Tests",
                questions: [
                    { id: "modality_intro_blood_test", text: "Researchers are developing new types of screening tests. One of the most promising is a blood test that could help find lung cancer early by detecting signs that cancer can release into the blood. While these tests are improving, they are not yet perfect.", type: "info" },
                    { id: "modality_consider_blood_test", text: "Would you consider having this new blood test?", type: "Y/N" },
                    { id: "modality_blood_test_routine", text: "If the blood test was added routinely (e.g., to another blood sample you were already giving), would this make you...", type: "scale", options: ["Much less likely to have it", "Less likely", "Equally likely", "More likely", "Much more likely to have it"] },
                    { id: "modality_blood_test_self_collect", text: "If the blood test was self-collected at home (e.g., a finger-prick test), would this make you...", type: "scale", options: ["Much less likely to have it", "Less likely", "Equally likely", "More likely", "Much more likely to have it"] },
                    { id: "modality_blood_test_multi_cancer", text: "If the blood test could also detect other types of cancer (not just lung cancer), would this make you...", type: "scale", options: ["Much less likely to have it", "Less likely", "Equally likely", "More likely", "Much more likely to have it"] },
                    
                    { id: "modality_blood_test_in_addition", text: "Would you consider having this new blood test in addition to a scan?", type: "scale", options: ["Very unlikely", "Unlikely", "Neutral", "Likely", "Very likely"] },
                    { id: "modality_blood_test_instead", text: "Would you consider having this new blood test instead of a scan?", type: "scale", options: ["Very unlikely", "Unlikely", "Neutral", "Likely", "Very likely"] },
                    { id: "modality_preference_ct_blood_same", text: "Overall, would you be more likely to have a CT scan, more likely to have the new blood test, or are you equally likely to have either?", type: "categorical", options: ["More likely to have a CT scan", "More likely to have a blood test", "Equally likely to have either"] },

                    { id: "modality_agreement_intro", text: "Thinking about the new blood test, to what extent do you agree or disagree with the following statements:", type: "info" },
                    { id: "modality_agree_convenient", text: "A blood test for lung cancer screening would be more convenient than a CT scan.", type: "agreement_scale" },
                    { id: "modality_agree_less_anxious", text: "I would be less anxious about a blood test than a CT scan.", type: "agreement_scale" },
                    { id: "modality_agree_more_likely", text: "I would be more likely to participate in screening if it involved a blood test.", type: "agreement_scale" },
                    { id: "modality_agree_less_invasive", text: "A blood test would feel less invasive than a CT scan.", type: "agreement_scale" },
                    { id: "modality_agree_less_radiation", text: "I would be less concerned about radiation exposure with a blood test.", type: "agreement_scale" },
                    { id: "modality_agree_accuracy_worry", text: "I would worry if a blood test was not as accurate as a CT scan.", type: "agreement_scale" },
                    { id: "fp_explainer", text: "A 'false positive' is when a test incorrectly suggests a person might have cancer, leading to unnecessary worry and further tests.", type: "info" },
                    { id: "modality_concern_false_positives", text: "To what extent are you concerned about false positives from a blood test?", type: "scale", options: ["Not at all concerned", "Slightly concerned", "Moderately concerned", "Very concerned", "Extremely concerned"] },
                    { id: "fn_explainer", text: "A 'false negative' is when a test fails to detect cancer that is actually there, giving false reassurance.", type: "info" },
                    { id: "modality_concern_false_negatives", text: "To what extent are you concerned about false negatives from a blood test?", type: "scale", options: ["Not at all concerned", "Slightly concerned", "Moderately concerned", "Very concerned", "Extremely concerned"] },
                    { id: "modality_w2p", text: "If a blood test could detect lung cancer early, how much would you pay to avoid a 10% risk of late-stage diagnosis?", type: "categorical", options: ["£0", "£1 - £20", "£21 - £50", "£51 - £100", "More than £100", "I would not pay"] }
                ]
            },
            {
                domain: "Discrete Choice Experiment (Part 1 of 2)",
                questions: [
                    { 
                        id: "dce_master_explainer",
                        type: "info",
                        text: `On the next few pages, we will ask you to make some choices. Imagine you are choosing between different types of lung health checks. No test is perfect, so you will have to trade-off between the good and bad features of each test.<br><br>
                   To help you choose, we will show you 5 key features for each test. Please read the explanations below carefully.<br><br>
                   <strong>1. Test Type: Where you take the test.</strong><br>
                   This could be a <strong>CT Scan</strong> (at a hospital), a <strong>Blood Test</strong> (at your GP), or a <strong>Home Test</strong> (a finger-prick kit).<br><br>
                   <strong>2. Detection Rate: How good the test is at finding cancer.</strong><br>
                   This tells you: Out of 100 people who <strong>do have</strong> early lung cancer, how many the test will correctly find. A higher number is better.<br><br>
                   <strong>3. False Alarm Rate (False Positives): How often the test gives a wrong 'red flag'.</strong><br>
                   This tells you: Out of 100 people who <strong>do not have</strong> lung cancer, how many will be incorrectly told they might have a problem (this is also called a 'false positive'). A lower number is better.<br><br>
                   <strong>4. Follow-up Procedure: What happens after a 'red flag'.</strong><br>
                   If the first test shows a possible problem, this is the very next step. It could be to <strong>Repeat the same test</strong>, have a <strong>CT Scan</strong>, or an <strong>immediate hospital referral for biopsy</strong>.<br><br>
                   <strong>5. Cost: A one-off payment for the test.</strong><br>To help the NHS understand which features are most important to people when planning future services, we ask you to imagine there was a one-off cost for the test. <strong>This is a completely hypothetical question to understand what you value most. There is no plan to charge for NHS screening.</strong><br><br>
                   On the next pages, you will see two options at a time. Please choose the one you would prefer. There are no right or wrong answers.`
                    },
                    { id: "dce_task_1", type: "dce_task", text: "Choice 1 of 6", options: { optionA: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "95 out of 100", "False Alarm Rate": "10 in 100", "Follow-up": "A CT Scan", "Cost": "£0" }, optionB: { "Test Type": "Blood Test (at GP)", "Detection Rate": "90 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "A CT Scan", "Cost": "£25" }}},
                    { id: "dce_task_2", type: "dce_task", text: "Choice 2 of 6", options: { optionA: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "85 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "Repeat the test", "Cost": "£0" }, optionB: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "90 out of 100", "False Alarm Rate": "5 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£75" }}},
                    { id: "dce_task_3", type: "dce_task", text: "Choice 3 of 6", options: { optionA: { "Test Type": "Blood Test (at GP)", "Detection Rate": "95 out of 100", "False Alarm Rate (false positive)": "5 in 100", "Follow-up": "Repeat the test", "Cost": "£25" }, optionB: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "90 out of 100", "False Alarm Rate (false positive)": "10 in 100", "Follow-up": "A CT Scan", "Cost": "£0" }}},
                    { id: "dce_task_4", type: "dce_task", text: "Choice 4 of 6", options: { optionA: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "85 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£25" }, optionB: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "95 out of 100", "False Alarm Rate": "5 in 100", "Follow-up": "Repeat the test", "Cost": "£75" }}},
                    { id: "dce_task_5", type: "dce_task", text: "Choice 5 of 6", options: { optionA: { "Test Type": "Blood Test (at GP)", "Detection Rate": "90 out of 100", "False Alarm Rate": "10 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£75" }, optionB: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "95 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "A CT Scan", "Cost": "£25" }}},
                    { id: "dce_task_6", type: "dce_task", text: "Choice 6 of 6", options: { optionA: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "90 out of 100", "False Alarm Rate (false positive)": "5 in 100", "Follow-up": "A CT Scan", "Cost": "£25" }, optionB: { "Test Type": "Blood Test (at GP)", "Detection Rate": "85 out of 100", "False Alarm Rate (false positive)": "1 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£0" }}}
                ]
            },
            {
                domain: "Discrete Choice Experiment (Part 2 of 2)",
                questions: [
                    { id: "dce_task_7", type: "dce_task", text: "Choice 1 of 6", options: { optionA: { "Test Type": "Blood Test (at GP)", "Detection Rate": "85 out of 100", "False Alarm Rate": "10 in 100", "Follow-up": "Repeat the test", "Cost": "£75" }, optionB: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "90 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£0" }}},
                    { id: "dce_task_8", type: "dce_task", text: "Choice 2 of 6", options: { optionA: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "95 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "A CT Scan", "Cost": "£25" }, optionB: { "Test Type": "Blood Test (at GP)", "Detection Rate": "90 out of 100", "False Alarm Rate": "5 in 100", "Follow-up": "Repeat the test", "Cost": "£75" }}},
                    { id: "dce_task_9", type: "dce_task", text: "Choice 3 of 6", options: { optionA: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "90 out of 100", "False Alarm Rate (false positive)": "10 in 100", "Follow-up": "Repeat the test", "Cost": "£0" }, optionB: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "85 out of 100", "False Alarm Rate (false positive)": "5 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£25" }}},
                    { id: "dce_task_10", type: "dce_task", text: "Choice 4 of 6", options: { optionA: { "Test Type": "Blood Test (at GP)", "Detection Rate": "95 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£0" }, optionB: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "85 out of 100", "False Alarm Rate": "10 in 100", "Follow-up": "Repeat the test", "Cost": "£75" }}},
                    { id: "dce_task_11", type: "dce_task", text: "Choice 5 of 6", options: { optionA: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "90 out of 100", "False Alarm Rate": "1 in 100", "Follow-up": "Repeat the test", "Cost": "£75" }, optionB: { "Test Type": "Blood Test (at GP)", "Detection Rate": "95 out of 100", "False Alarm Rate": "10 in 100", "Follow-up": "A CT Scan", "Cost": "£25" }}},
                    { id: "dce_task_12", type: "dce_task", text: "Choice 6 of 6", options: { optionA: { "Test Type": "CT Scan (at hospital)", "Detection Rate": "95 out of 100", "False Alarm Rate (false positive)": "5 in 100", "Follow-up": "Immediate hospital referral for biopsy", "Cost": "£25" }, optionB: { "Test Type": "Home Test (finger-prick)", "Detection Rate": "85 out of 100", "False Alarm Rate (false positive)": "1 in 100", "Follow-up": "A CT Scan", "Cost": "£0" }}}
                ]
            },
            {
                domain: "Optional Section",
                questions: [
                    {
                        id: "comm_opt_in",
                        text: "The next two sections contain optional questions about public health messages used in posters and letters. Your feedback here can help improve how the NHS communicates with people. Would you like to answer these questions?",
                        type: "Y/N"
                    }
                ]
            },
            {
                domain: "Communications & Messaging 1 (Poster)",
                questions: [
                    { id: "comm_intro_poster", text: "Imagine you saw the following messages on a poster in your GP's waiting room. Please select the top 3 that would most motivate you to ask about a lung health check.", type: "communication_choice_poster",
                      condition: { id: "comm_opt_in", value: "Yes" },
                      options: [
                        "Missing this free lung health check could cost you the chance to catch something early. Don't take that risk.",
                        "Imagine it's a year from now, and you wish you had taken this simple test. Don't wait for regret—act now.",
                        "Many people in your local area who were invited to a Lung Health Check chose to attend. Join them in taking charge of your health.",
                        "Your GP believes this lung health check is an important step for you. Follow their advice for your health.",
                        "Appointments fill up fast—book your free Lung Health Check today to secure your spot.",
                        "It only takes 15 minutes for a potentially life-saving check. Quick, easy, and free.",
                        "This free check has been reserved just for you. Don't let it go unused.",
                        "Taking care of your health means being there for your family. Do it for them.",
                        "People who care about their health take advantage of opportunities like this. Does that sound like you?"
                    ]}
                ]
            },
            {
                domain: "Communications & Messaging 2 (Letter)",
                questions: [
                    { id: "comm_intro_letter", text: "Now, imagine you received a letter with the following sentences. Please select the top 3 that would most motivate you to book your appointment.", type: "communication_choice_letter",
                      condition: { id: "comm_opt_in", value: "Yes" },
                      options: [
                        "Your GP, Dr. Smith, has personally reviewed your details and recommends you attend this lung health check.",
                        "Based on your health profile, you are in a group that benefits most from lung screening. This check is specifically recommended for you.",
                        "Your first appointment is a simple phone call. If a scan is needed, your local centre is at the Royal Marsden Hospital.",
                        "You've met the key criteria for this health check: ✔ Aged 55-74 ✔ Smoked in the past.",
                        "A spot has been reserved for you at your local lung health check clinic. Please call to confirm your appointment.",
                        "Did you know? 6 out of 10 people in your area who were invited have already attended their lung health check.",
                        "Many people who attend a lung health check are successfully supported to stop smoking afterwards.",
                        "If you miss this appointment, your next routine invitation may not be for another two years. Please don't delay."
                    ]}
                ]
            },
            {
                domain: "Technology & AI",
                questions: [
                    { id: "info_confidence", text: "How confident do you feel that you could access all the information you need about lung cancer screening?", type: "scale", options: ["Not at all confident", "Slightly confident", "Moderately confident", "Very confident", "Extremely confident"] },
                    { id: "ai_familiarity", text: "How familiar are you with using Artificial Intelligence (AI) or 'chatbots' in healthcare (e.g., online symptom checkers)?", type: "scale", options: ["Not at all familiar", "Slightly familiar", "Moderately familiar", "Very familiar", "Extremely familiar"] },
                    { id: "ai_interest", text: "We are developing an AI-powered tool (like a chatbot) to help people understand lung cancer screening. Would you be interested in answering more questions in the future about how such a tool could be designed?", type: "Y/N" }
                ]
            }
        ];

        // --- APPLICATION LOGIC ---
        let currentStep = 0;
        const responses = {};

        const questionnaireContainer = document.getElementById('questionnaire-container');
        const backBtn = document.getElementById('back-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = document.getElementById('progress-percentage');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        function renderStep(stepIndex) {
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => step.classList.add('hidden'));

            const currentStepElement = document.getElementById(`step-${stepIndex}`);
            if (currentStepElement) {
                currentStepElement.classList.remove('hidden');
                evaluateConditions(stepIndex);
            }
            
            progressContainer.style.display = stepIndex === 0 ? 'none' : 'block';
            updateNavigation();
            updateProgressBar();
        }

        function createQuestionHTML(question) {
            let inputHTML = '';
            let optionWrapperClass = '';
            if (question.layout === 'horizontal') {
                optionWrapperClass = 'flex flex-wrap gap-x-4 gap-y-2 mt-2';
            }

            switch (question.type) {
                case 'info':
                    return `<div class="p-4 my-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg"><p class="text-gray-700 leading-relaxed">${question.text}</p></div>`;
                case 'checkbox':
                    return `<label class="flex items-start mt-4 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="${question.id}" name="${question.id}" class="form-checkbox mt-1">
                                <span class="ml-3 text-gray-700">${question.text}</span>
                            </label>`;
                case 'multi_checkbox':
                    inputHTML = `<div class="${optionWrapperClass}">` + question.options.map(opt => `
                        <label class="flex items-center mt-2">
                            <input type="checkbox" class="form-checkbox" name="${question.id}" value="${opt}">
                            <span class="ml-2 text-gray-700">${opt}</span>
                        </label>
                    `).join('') + `</div>`;
                    break;
               case 'communication_choice_poster':
                    const posterHeader = `
                        <div class="border-4 border-blue-600 rounded-lg p-4 bg-blue-50 text-center">
                            <h3 class="text-2xl font-bold text-blue-800">Your Lungs. Your Life.</h3>
                            <p class="text-lg text-blue-700">A free NHS lung health check is available for you.</p>
                        </div>`;
                    const posterCheckboxes = `<div class="border-4 border-blue-600 rounded-b-lg border-t-0 p-6">` + question.options.map(opt => `
                        <label class="flex items-start mt-2 p-2 rounded hover:bg-blue-100">
                            <input type="checkbox" class="form-checkbox mt-1" name="${question.id}" value="${opt}">
                            <span class="ml-3 text-gray-700">${opt}</span>
                        </label>
                    `).join('') + `</div>`;
                    inputHTML = posterHeader + posterCheckboxes;
                    break;
                case 'communication_choice_letter':
                    const letterhead = `
                        <div class="border rounded-t-lg p-4 bg-gray-50">
                             <div class="flex justify-between items-center">
                                 <h3 class="font-bold text-lg text-gray-800">Lung Cancer Screening</h3>
                                 <span class="font-bold text-xl text-blue-600">NHS</span>
                            </div>
                        </div>`;
                    const rippedEdge = `<div style="background: linear-gradient(to bottom, #f9fafb 0%, #f9fafb 50%, transparent 50%);">
                                            <svg viewbox="0 0 100 10" preserveAspectRatio="none" style="display: block; width: 100%; height: 20px; transform: translateY(-10px);">
                                                <path d="M0,5 Q5,0 10,5 T20,5 Q25,0 30,5 T40,5 Q45,0 50,5 T60,5 Q65,0 70,5 T80,5 Q85,0 90,5 T100,5" stroke="#d1d5db" stroke-width="0.5" fill="#f9fafb"/>
                                            </svg>
                                        </div>`;
                    const checkboxes = `<div class="border border-t-0 rounded-b-lg p-6">` + question.options.map(opt => `
                        <label class="flex items-start mt-2 p-2 rounded hover:bg-gray-100">
                            <input type="checkbox" class="form-checkbox mt-1" name="${question.id}" value="${opt}">
                            <span class="ml-3 text-gray-700">${opt}</span>
                        </label>
                    `).join('') + `</div>`;
                    inputHTML = letterhead + rippedEdge + checkboxes;
                    break;
                case 'textarea':
                    inputHTML = `<textarea id="${question.id}" name="${question.id}" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="${question.placeholder || ''}"></textarea>`;
                    break;
                case 'text':
                case 'email':
                case 'tel':
                    inputHTML = `<input type="${question.type}" id="${question.id}" name="${question.id}" placeholder="${question.placeholder || ''}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">`;
                    break;
                case 'number':
                    inputHTML = `<input type="number" id="${question.id}" name="${question.id}" placeholder="${question.placeholder || ''}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">`;
                    break;
                case 'Y/N':
                case 'Y/N/Unsure':
                    const optionsYN = question.type === 'Y/N' ? ['Yes', 'No'] : ['Yes', 'No', 'Unsure'];
                    inputHTML = `<div class="${optionWrapperClass}">` + optionsYN.map(opt => `
                        <label class="inline-flex items-center mt-2 mr-4">
                            <input type="radio" class="form-radio" name="${question.id}" value="${opt}">
                            <span class="ml-2 text-gray-700">${opt}</span>
                        </label>
                    `).join('') + `</div>`;
                    break;
                case 'T/F/DK':
                    const optionsTFK = ['True', 'False', "Don't know"];
                    inputHTML = `<div class="${optionWrapperClass}">` + optionsTFK.map(opt => `
                        <label class="flex items-center mt-2">
                            <input type="radio" class="form-radio" name="${question.id}" value="${opt}">
                            <span class="ml-2 text-gray-700">${opt}</span>
                        </label>
                    `).join('') + `</div>`;
                    break;
                case 'dce_task':
                    const headers = Object.keys(question.options.optionA);
                    const tableRows = headers.map(header => {
                        let annotation = '';
                        if (header === "Detection Rate") {
                            annotation = '<span class="text-green-600 text-sm font-normal ml-2">(higher is better)</span>';
                        } else if (header.includes("False Alarm Rate")) {
                            annotation = '<span class="text-red-600 text-sm font-normal ml-2">(lower is better)</span>';
                        } else if (header === "Cost") {
                            annotation = '<span class="text-red-600 text-sm font-normal ml-2">(lower is better)</span>';
                        }
                        
                        return `
                        <tr>
                            <td class="feature-label">${header}${annotation}</td>
                            <td>${question.options.optionA[header]}</td>
                            <td>${question.options.optionB[header]}</td>
                        </tr>
                        `;
                    }).join('');

                    inputHTML = `
                        <table class="dce-table">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Option A</th>
                                    <th>Option B</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                        <div class="mt-6">
                            <p class="text-center font-medium text-gray-700">Which option would you choose?</p>
                            <div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <input type="radio" id="${question.id}_A" name="${question.id}" value="A" class="sr-only">
                                    <label for="${question.id}_A" class="dce-choice-label text-center">I would choose Option A</label>
                                </div>
                                <div>
                                    <input type="radio" id="${question.id}_B" name="${question.id}" value="B" class="sr-only">
                                    <label for="${question.id}_B" class="dce-choice-label text-center">I would choose Option B</label>
                                </div>
                                <div>
                                    <input type="radio" id="${question.id}_none" name="${question.id}" value="None" class="sr-only">
                                    <label for="${question.id}_none" class="dce-choice-label text-center">I would not choose either</label>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'slider':
                    inputHTML = `
                        <div class="mt-2">
                            <input type="range" id="${question.id}" name="${question.id}" min="${question.min}" max="${question.max}" value="${(question.min + question.max) / 2}" class="w-full">
                            <div class="flex justify-between text-sm text-gray-600 mt-1">
                                <span>${question.minLabel}</span>
                                <span class="font-bold text-lg text-blue-600" id="${question.id}-value">${(question.min + question.max) / 2}</span>
                                <span>${question.maxLabel}</span>
                            </div>
                        </div>
                    `;
                    break;
                case 'categorical':
                case 'scale':
                    inputHTML = `<div class="${optionWrapperClass}">` + question.options.map(opt => `
                        <label class="flex items-center mt-2">
                            <input type="radio" class="form-radio" name="${question.id}" value="${opt}">
                            <span class="ml-2 text-gray-700">${opt}</span>
                        </label>
                    `).join('') + `</div>`;
                    break;
                case 'agreement_scale':
                    const agreementOptions = ["Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"];
                     inputHTML = `<div class="flex flex-col sm:flex-row justify-between mt-2">${agreementOptions.map((opt, index) => `
                        <label class="flex flex-col items-center mt-2 text-center text-sm text-gray-600 w-full sm:w-auto">
                            <input type="radio" class="form-radio scale-radio" name="${question.id}" value="${opt}">
                            <span class="mt-1">${opt}</span>
                        </label>
                    `).join('')}</div>`;
                    break;
            }

            // For all question types except 'info', wrap them for consistent layout
            if (question.type !== 'info') {
                 return `
                    <div id="question-wrapper-${question.id}" class="my-6 question-wrapper">
                        <label class="block text-md font-medium text-gray-800">${question.text}</label>
                        ${inputHTML}
                    </div>
                `;
            }
            return inputHTML; // 'info' types are returned directly
        }

        function initializeQuestionnaire() {
            questionnaireContainer.innerHTML = ''; // Clear previous content
            questionnaireData.forEach((stepData, index) => {
                const stepElement = document.createElement('div');
                stepElement.id = `step-${index}`;
                stepElement.className = 'step hidden';
                
                let stepTitleHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">${stepData.domain}</h2>`;
                if (index === 0) {
                    stepTitleHTML = ''; // No title for the welcome screen
                }

                const questionsHTML = stepData.questions.map(createQuestionHTML).join('');
                stepElement.innerHTML = stepTitleHTML + questionsHTML;
                questionnaireContainer.appendChild(stepElement);
            });
            
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', () => evaluateConditions(currentStep));
            });
            
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const valueDisplay = document.getElementById(`${slider.id}-value`);
                if(valueDisplay) {
                    slider.addEventListener('input', (event) => {
                        valueDisplay.textContent = event.target.value;
                    });
                }
            });

             // Add listener for communication choice checkboxes to limit selection to 3
            ['comm_intro_poster', 'comm_intro_letter'].forEach(id => {
                 const question = findQuestionById(id);
                 if(!question) return;

                 const checkboxes = document.querySelectorAll(`input[name="${question.id}"]`);
                 checkboxes.forEach(checkbox => {
                     checkbox.addEventListener('change', () => {
                         const checkedCount = document.querySelectorAll(`input[name="${question.id}"]:checked`).length;
                         if (checkedCount > 3) {
                             checkbox.checked = false;
                         }
                     });
                 });
             });

            renderStep(0);
        }

        function evaluateConditions(stepIndex) {
            const stepData = questionnaireData[stepIndex];
            if (!stepData) return;
            
            saveResponses(); // Save current state before re-evaluating

            stepData.questions.forEach(question => {
                const wrapper = document.getElementById(`question-wrapper-${question.id}`);
                if (question.condition && wrapper) {
                    const conditionMet = checkCondition(question.condition);
                    wrapper.classList.toggle('hidden', !conditionMet);
                }
            });
             // Also re-evaluate conditions for the next steps to hide/show entire pages
            for (let i = stepIndex + 1; i < questionnaireData.length; i++) {
                const domain = questionnaireData[i];
                // Check if the first question of a domain has a condition
                if (domain.questions[0] && domain.questions[0].condition) {
                     const stepElement = document.getElementById(`step-${i}`);
                     if(stepElement) {
                        const conditionMet = checkCondition(domain.questions[0].condition);
                         // This is a simple implementation; we are not hiding from progress bar
                         // but this logic will apply when rendering the step itself.
                     }
                }
            }
            updateNavigation(); // Update nav buttons after conditions change
        }

        function checkCondition(condition) {
            if (condition.logic === 'AND') {
                return condition.rules.every(rule => getResponse(rule.id) === rule.value);
            } else if (condition.logic === 'OR') {
                return condition.rules.some(rule => getResponse(rule.id) === rule.value);
            } else {
                return getResponse(condition.id) === condition.value;
            }
        }

        function updateNavigation() {
            backBtn.classList.toggle('hidden', currentStep === 0);

            // Find next visible step
            let nextVisibleStep = -1;
            for (let i = currentStep + 1; i < questionnaireData.length; i++) {
                const firstQuestion = questionnaireData[i].questions[0];
                if (!firstQuestion.condition || checkCondition(firstQuestion.condition)) {
                    nextVisibleStep = i;
                    break;
                }
            }
            
            const isLastVisibleStep = nextVisibleStep === -1;
            nextBtn.classList.toggle('hidden', isLastVisibleStep);
            submitBtn.classList.toggle('hidden', !isLastVisibleStep);
        }

        function updateProgressBar() {
            if (currentStep > 0) {
                const percentage = Math.round(((currentStep-1) / (questionnaireData.length - 2)) * 100);
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `Step ${currentStep} of ${questionnaireData.length-1}: ${questionnaireData[currentStep].domain}`;
                progressPercentage.textContent = `${percentage}%`;
            }
        }

        function saveResponses() {
            const currentStepData = questionnaireData[currentStep];
            currentStepData.questions.forEach(q => {
                const wrapper = document.getElementById(`question-wrapper-${q.id}`);
                if (wrapper && !wrapper.classList.contains('hidden')) {
                    if (q.type === 'multi_checkbox' || q.type === 'communication_choice_poster' || q.type === 'communication_choice_letter') {
                        const allCheckboxes = document.querySelectorAll(`input[name="${q.id}"]`);
                        const checkedValues = Array.from(allCheckboxes)
                                                .filter(cb => cb.checked)
                                                .map(cb => cb.value);
                        responses[q.id] = checkedValues;
                    } else {
                        const input = document.querySelector(`[name="${q.id}"]`);
                        if (input) {
                            if (input.type === 'radio') {
                                const checked = document.querySelector(`[name="${q.id}"]:checked`);
                                responses[q.id] = checked ? checked.value : null;
                            } else if (input.type === 'checkbox') {
                                responses[q.id] = input.checked;
                            } else {
                                responses[q.id] = input.value;
                            }
                        }
                    }
                } else {
                    delete responses[q.id];
                }
            });
        }

        function getResponse(questionId) {
            return responses[questionId];
        }

        function validateStep() {
            hideMessage();
            return true; 
        }
        
        function showMessage(text, type = 'info') {
            messageText.textContent = text;
            messageBox.className = `mt-6 p-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function findQuestionById(id) {
            for (const step of questionnaireData) {
                const found = step.questions.find(q => q.id === id);
                if (found) return found;
            }
            return null;
        }

        nextBtn.addEventListener('click', () => {
            if (validateStep()) {
                saveResponses();
                
                let nextStep = currentStep + 1;
                // Skip optional sections if condition not met
                while(nextStep < questionnaireData.length) {
                    const firstQuestion = questionnaireData[nextStep].questions[0];
                    if (!firstQuestion.condition || checkCondition(firstQuestion.condition)) {
                        break; // This is the next valid step
                    }
                    nextStep++;
                }

                if (nextStep < questionnaireData.length) {
                    currentStep = nextStep;
                    renderStep(currentStep);
                }
            }
        });

        backBtn.addEventListener('click', () => {
            saveResponses();

            let prevStep = currentStep - 1;
             while(prevStep > 0) {
                const firstQuestion = questionnaireData[prevStep].questions[0];
                if (!firstQuestion.condition || checkCondition(firstQuestion.condition)) {
                    break; // This is the previous valid step
                }
                prevStep--;
            }

            if (prevStep >= 0) {
                currentStep = prevStep;
                renderStep(currentStep);
            }
        });

      submitBtn.addEventListener('click', () => {
    if (validateStep()) {
        saveResponses();
        
        // The URL from Step 1
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzS9JbC-hyko-_oHsmOTw8foW61EK5B057qonr36sZevE4IRZrH7jCc3WGs8rKmnMJT/exec';

        fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify(responses),
        })
        .then(response => {
            showMessage('Submitted successfully! Thank you.', 'success');
            // Hide the questionnaire as you did before
            questionnaireContainer.innerHTML = '';
            document.getElementById('navigation-container').classList.add('hidden');
        })
        .catch(error => {
            showMessage('Error submitting form. Please contact the study team.', 'error');
            console.error('Error!', error.message);
        });
    }
});

        // Initial setup
        initializeQuestionnaire();
    </script>
</body>
</html>
